var ffi = require("ffi")

var libwiringPi = ffi.Library('/usr/local/lib/libwiringPi', {
                              'wiringPiSetup' : [ 'int', [] ],
                              'digitalWrite' : [ 'void', ['int', 'int'] ],
                              'pinMode': [ 'void', ['int', 'int'] ],
                              'delayMicroseconds' :  [ 'void', ['int', 'int'] ]
                              })

var libLivolo = ffi.Library('./libLivoloWrapper', {
                              'newLivolo' : ['pointer', ['char'] ],
                              'Livolo_SendButton': ['void', [ 'pointer', 'int', 'char' ] ]
                              })

var pinMapping = {
    "3": 0,
    "5": 1,
    "7": 4,
    "8": 14,
    "10": 15,
    "11": 17,
    "12": 18,
    "13": 21,
    "15": 22,
    "16": 23,
    "18": 24,
    "19": 10,
    "21": 9,
    "22": 25,
    "23": 11,
    "24": 8,
    "26": 7,
    
    // Model A+ and Model B+ pins
    "29": 5,
    "31": 6,
    "32": 12,
    "33": 13,
    "35": 19,
    "36": 16,
    "37": 26,
    "38": 20,
    "40": 21
};

if (rev == 2) {
    pinMapping["3"] = 2;
    pinMapping["5"] = 3;
    pinMapping["13"] = 27;
}

function isNumber(number) {
    return !isNaN(parseInt(number, 10));
}

function sanitizePinNumber(pinNumber) {
    if (!isNumber(pinNumber) || !isNumber(pinMapping[pinNumber])) {
        throw new Error("Pin number isn't valid");
    }
    
    return parseInt(pinNumber, 10);
}

var livolo = {

mySwitch,
    
open: function(pinNumber, callback) {
    pinNumber = sanitizePinNumber(pinNumber);
    
    mySwitch = libLivolo.newLivolo(pinNumber);
    
    if (libwiringPi.wiringPiSetup() == -1){
        throw new Error("Error initialising WiringPi");
    }
    
    if (mySwitch.isNull()) {
        throw new Error("Error initialising Livolo");
    }
},

    
close: function(pinNumber, callback) {
    pinNumber = sanitizePinNumber(pinNumber);
    
    libLivolo.delete(mySwitch);
},
    
read: function(groupId, deviceId, callback) {
    groupId = sanitizePinNumber(groupId);
    deviceId = sanitizePinNumber(deviceId);
},
    
write: function(groupId, deviceId, callback) {
    groupId = sanitizePinNumber(groupId);
    deviceId = sanitizePinNumber(deviceId);
    
    libLivolo.Livolo_SendButton(mySwitch, groupId, deviceId);
}
};

livolo.export = livolo.open;
livolo.unexport = livolo.close;

module.exports = livolo;